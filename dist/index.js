var N=Object.defineProperty;var _=e=>N(e,"__esModule",{value:!0});var j=(e,t)=>{_(e);for(var n in t)N(e,n,{get:t[n],enumerable:!0})};j(exports,{Concept:()=>s,NULL_CONCEPT:()=>y,astToTokenTree:()=>I,createTemplate:()=>rt,extractVariables:()=>D,filterUniqueConcepts:()=>g,getConceptsDeep:()=>U,getPatternMatches:()=>ot,getPatternVariables:()=>X,interpolate:()=>J,interpolateToConcept:()=>b,interpolateToConcepts:()=>Q,isAtom:()=>T,isCompound:()=>C,isPattern:()=>h,isTextBlock:()=>tt,isVariable:()=>x,parseConcept:()=>q,parseConcepts:()=>L,toConcept:()=>nt,toConcepts:()=>k,tokenTreeToConcept:()=>H});var O=(e,t)=>{let n=[],r={offset:0,line:1,column:1},o=c=>{for(let a of t){let p=a.match(c);if(p){let u=p.split(`
`),m={offset:r.offset+p.length,line:r.line+u.length-1,column:u.length>0?u.slice(-1)[0].length:r.column+p.length};return{kind:a,loc:{start:r,end:m,source:p}}}}return null},i=e;for(;i.length>0;){let c=o(i);if(!c)throw new Error(`Unknown input starting at line ${r.line}, column ${r.column}`);n.push(c),r=c.loc.end,i=i.slice(c.loc.source.length)}return n},l=(e,t)=>({name:e,match:n=>(t.exec(n)||[])[0]}),f=class extends Error{constructor(t,n){let{line:r,column:o}=n.loc.start;super(`${t instanceof Error?t.message:"message"} (line ${r}, column ${o})`);this.token=n}};var s=class{constructor(t){let n=t.parts||[];n.length===1&&(n=n[0].parts);let r=n.length>0?s.join(n):t.key||"";this.key=r,this.parts=n,this.shape=s.computeShape(this)}static computeShape(t){if(t.parts.length===0)return 0;let n=t.parts.map(s.computeShape);return n.every(r=>r===0)?n.length:n}static createAtom(t){return new s({key:t})}static createCompound(t){return new s({parts:t.map(n=>Array.isArray(n)?s.createCompound(n):n instanceof s?n:s.createAtom(n))})}static join(t){return t.map(n=>n.parts.length>=2?`[${n.key}]`:n.key).join(" ")}toString(){return this.key}},y=s.createAtom(""),g=e=>{let t=new Map;return e.forEach(n=>t.set(n.key,n)),Array.from(t.values())},U=e=>{let t=new Map;return e.forEach(n=>{t.set(n.key,n),U(n.parts).forEach(r=>{t.set(r.key,r)})}),Array.from(t.values())},T=e=>e.parts.length===0,x=e=>T(e)&&e.key[0]==="$",h=e=>C(e)&&e.parts.some(t=>x(t)||h(t)),C=e=>e.parts.length>1,tt=e=>e.key.slice(0,2)+e.key.slice(-2)==="<<>>";var $=(e,t)=>e.length===0?t:t.length===0?e:e.flatMap(n=>t.map(r=>[...n,...r])),z=(e,t)=>{e.forEach((n,r)=>{t({item:e[r],prev:e[r-1],next:e[r+1],prevAll:function*(){for(let o=r-1;o>=0;o-=1)yield e[o];return null},nextAll:function*(){for(let o=r+1;o<e.length;o+=1)yield e[o];return null}})})};var G=(e,t)=>{let n=new Map;return e.forEach(r=>{n.set(t(r),r)}),Array.from(n.values())};var v={};j(v,{AtomKind:()=>d,CommaKind:()=>w,CurlyLeftKind:()=>S,CurlyRightKind:()=>A,NewlineSeparatorKind:()=>P,ParenLeftKind:()=>R,ParenRightKind:()=>E,SemicolonKind:()=>V,SquareLeftKind:()=>K,SquareRightKind:()=>B,WhitespaceKind:()=>et});var P=l("NewlineSeparator",/^([ \t]*\n[ \t]*)+/),et=l("Whitespace",/^[ \t]+/),S=l("CurlyLeft",/^\{/),A=l("CurlyRight",/^\}/),K=l("SquareLeft",/^\[/),B=l("SquareRight",/^\]/),R=l("ParenLeft",/^\(/),E=l("ParenRight",/^\)/),w=l("ParenRight",/^,/),V=l("ParenRight",/^;/),d=l("Atom",/^<<(.|\n)+?>>|^[^ \n\t\{\}\[\]\(\)\,\;]+/);var M=class{constructor(){let t={type:"Permutation",children:[]},n={type:"Root",children:[t]};this.context={permutation:t,block:n},this.root=n}end(){let t=this.context;for(;t;)this.terminatePermutation(),t=t.parent;return this}terminatePermutation(){return this.context.permutation.children.length===0&&this.context.block.children.pop(),this}consumeAtomToken(t){if(t.kind!==d)throw new f("Token must be an Atom",t);let n={token:t,type:"Atom",text:t.loc.source};return this.context.permutation.children.push(n),this}nextPermutation(){this.terminatePermutation();let t={type:"Permutation",children:[]};return this.context.block.children.push(t),this.context.permutation=t,this}startPermutationBlock(t){let n={type:"Permutation",children:[]},r={type:t,children:[n]};return this.context.permutation.children.push(r),this.context={block:r,permutation:n,parent:this.context},this}endPermutationBlock(){let{parent:t}=this.context;if(!t)throw new Error("Unexpected block ending");return this.terminatePermutation(),this.context=this.context.parent,this}};var W=e=>{let t=new M;return z(e,({item:n})=>{try{switch(n.kind){case d:t.consumeAtomToken(n);break;case S:t.startPermutationBlock("PermutationBlock");break;case A:t.endPermutationBlock();break;case K:t.startPermutationBlock("EmbeddedPermutationBlock");break;case B:t.endPermutationBlock();break;case R:t.startPermutationBlock("ParentheticalPermutationBlock");break;case E:t.endPermutationBlock();break;case w:t.nextPermutation();break;case V:t.nextPermutation();break;case P:t.nextPermutation();break;default:break}}catch(r){throw new f(r,n)}}),t.end().root};var F=e=>{if(T(e))return e;let[t,...n]=e.parts,r=!1,o=c=>C(c)?s.createCompound(c.parts.map(o)):c.key==="&"?(r=!0,t):c,i=n.map(o);return r?s.createCompound(i):e};var L=e=>{e=Array.isArray(e)?e.join(`
`):e;let t=O(e,Object.values(v)),n=W(t),r=I(n);return g(r.map(H))},q=e=>L(e)[0]||y,nt=e=>e instanceof s?e:s.createAtom(e),k=e=>Array.isArray(e)?e.flatMap(k):e instanceof s?[e]:L(e),H=e=>{if(e.length===0)return null;let t=r=>{let o=r.map(i=>Array.isArray(i)?t(i):s.createAtom(i.loc.source)).filter(Boolean);return o.length===1?o[0]:s.createCompound(o)},n=t(e);return F(n)},I=e=>{let t=[],n=(o,i=[])=>{switch(o.type){case"Atom":return[[o.token]];case"TextBlock":return[[o.token]];case"Root":return o.children.flatMap(a=>n(a,[]));case"PermutationBlock":return o.children.flatMap(a=>n(a,[]));case"ParentheticalPermutationBlock":return o.children.forEach(a=>{let p=$(i,n(a));t.push(...p)}),[];case"EmbeddedPermutationBlock":return o.children.flatMap(a=>n(a,[]).map(p=>[p]));case"Permutation":{let c=o,a=[],p=[];return c.children.forEach(u=>{let m=n(u,p);a.length===0?a=m:m.length>0&&(a=a.flatMap(Y=>m.map(Z=>[...Y,...Z]))),p=m}),a}default:throw new Error("Unhandled AST node type: "+o.type)}};return[...n(e),...t]};var rt=e=>{let t=k(e),n=Q.bind(null,t);return{patterns:t,interpolate:n}},ot=(e,t)=>{let n=[];return e.forEach(r=>{let o=r.parts.length;t.filter(i=>i.parts.length===o&&i.key!==r.key).forEach(i=>{let c=D(i,r);c&&n.push({pattern:r,concept:i,variables:c})})}),n},J=(e,t)=>typeof e=="string"?J(q(e),t):b(e,t).key,b=(e,t)=>h(e)?s.createCompound(e.parts.map(n=>b(n,t))):t[e.key]?k(t[e.key])[0]:e,Q=(e,t)=>{let n=k(e),r={};Object.entries(t).forEach(([i,c])=>{r[i]=k(c)});let o=Object.entries(r).reduce((i,[c,a])=>a.flatMap(p=>i.map(u=>b(u,{[c]:p}))),n);return G(o,i=>i.key)},D=(e,t)=>{let n=t.parts.length;if(e.parts.length!==n)return null;let r={};for(let o=0;o<n;o+=1){let i=e.parts[o],c=t.parts[o];if(x(c)){let a=c.key,p=r[a];if(p&&p.key!==i.key)return null;r[a]=i}else if(h(c)){let a=D(i,c);if(!a)return null;for(let[p,u]of Object.entries(a)){let m=r[p];if(m&&m.key!==u.key)return null;r[p]=u}}else if(i.key!==c.key)return null}return r},X=(...e)=>{let t=new Map;return e.flat().forEach(n=>{x(n)?t.set(n.key,n):h(n)&&X(n.parts).forEach(r=>{t.set(r.key,r)})}),Array.from(t.values())};0&&(module.exports={Concept,NULL_CONCEPT,astToTokenTree,createTemplate,extractVariables,filterUniqueConcepts,getConceptsDeep,getPatternMatches,getPatternVariables,interpolate,interpolateToConcept,interpolateToConcepts,isAtom,isCompound,isPattern,isTextBlock,isVariable,parseConcept,parseConcepts,toConcept,toConcepts,tokenTreeToConcept});

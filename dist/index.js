(()=>{var M=Object.defineProperty;var I=e=>M(e,"__esModule",{value:!0});var J=(e,t)=>{I(e);for(var n in t)M(e,n,{get:t[n],enumerable:!0})};var L=(e,t)=>{let n=[],r={offset:0,line:1,column:1},o=c=>{for(let a of t){let p=a.match(c);if(p){let u=p.split(`
`),m={offset:r.offset+p.length,line:r.line+u.length-1,column:u.length>0?u.slice(-1)[0].length:r.column+p.length};return{kind:a,loc:{start:r,end:m,source:p}}}}return null},i=e;for(;i.length>0;){let c=o(i);if(!c)throw new Error(`Unknown input starting at line ${r.line}, column ${r.column}`);n.push(c),r=c.loc.end,i=i.slice(c.loc.source.length)}return n},l=(e,t)=>({name:e,match:n=>(t.exec(n)||[])[0]}),k=class extends Error{constructor(t,n){let{line:r,column:o}=n.loc.start;super(`${t instanceof Error?t.message:"message"} (line ${r}, column ${o})`);this.token=n}};var s=class{constructor(t){let n=t.parts||[];n.length===1&&(n=n[0].parts);let r=n.length>0?s.join(n):t.key||"";this.key=r,this.parts=n,this.shape=s.computeShape(this)}static computeShape(t){if(t.parts.length===0)return 0;let n=t.parts.map(s.computeShape);return n.every(r=>r===0)?n.length:n}static createAtom(t){return new s({key:t})}static createCompound(t){return new s({parts:t.map(n=>Array.isArray(n)?s.createCompound(n):n instanceof s?n:s.createAtom(n))})}static join(t){return t.map(n=>n.parts.length>=2?`[${n.key}]`:n.key).join(" ")}toString(){return this.key}},q=s.createAtom(""),D=e=>{let t=new Map;return e.forEach(n=>t.set(n.key,n)),Array.from(t.values())},Q=e=>{let t=new Map;return e.forEach(n=>{t.set(n.key,n),Q(n.parts).forEach(r=>{t.set(r.key,r)})}),Array.from(t.values())},C=e=>e.parts.length===0,T=e=>C(e)&&e.key[0]==="$",f=e=>b(e)&&e.parts.some(t=>T(t)||f(t)),b=e=>e.parts.length>1,ot=e=>e.key.slice(0,2)+e.key.slice(-2)==="<<>>";var N=(e,t)=>e.length===0?t:t.length===0?e:e.flatMap(n=>t.map(r=>[...n,...r])),j=(e,t)=>{e.forEach((n,r)=>{t({item:e[r],prev:e[r-1],next:e[r+1],prevAll:function*(){for(let o=r-1;o>=0;o-=1)yield e[o];return null},nextAll:function*(){for(let o=r+1;o<e.length;o+=1)yield e[o];return null}})})};var O=(e,t)=>{let n=new Map;return e.forEach(r=>{n.set(t(r),r)}),Array.from(n.values())};var w={};J(w,{AtomKind:()=>d,CommaKind:()=>R,CurlyLeftKind:()=>g,CurlyRightKind:()=>P,NewlineSeparatorKind:()=>y,ParenLeftKind:()=>B,ParenRightKind:()=>K,SemicolonKind:()=>E,SquareLeftKind:()=>S,SquareRightKind:()=>A,TextBlockKind:()=>x,WhitespaceKind:()=>X});var y=l("NewlineSeparator",/^([ \t]*\n[ \t]*)+/),X=l("Whitespace",/^[ \t]+/),g=l("CurlyLeft",/^\{/),P=l("CurlyRight",/^\}/),S=l("SquareLeft",/^\[/),A=l("SquareRight",/^\]/),B=l("ParenLeft",/^\(/),K=l("ParenRight",/^\)/),R=l("ParenRight",/^,/),E=l("ParenRight",/^;/),x=l("TextBlock",/^<<(.|\n)+?>>/),d=l("Atom",/^[^ \n\t\{\}\[\]\(\)\,\;]+/);var V=class{constructor(){let t={type:"Permutation",children:[]},n={type:"Root",children:[t]};this.context={permutation:t,block:n},this.root=n}end(){let t=this.context;for(;t;)this.terminatePermutation(),t=t.parent;return this}terminatePermutation(){return this.context.permutation.children.length===0&&this.context.block.children.pop(),this}consumeAtomToken(t){if(t.kind!==d)throw new k("Token must be an Atom",t);let n={token:t,type:"Atom",text:t.loc.source};return this.context.permutation.children.push(n),this}consumeTextBlockToken(t){if(t.kind!==x)throw new k("Token must be a TextBlock",t);let n={token:t,type:"TextBlock",text:t.loc.source};return this.context.permutation.children.push(n),this}nextPermutation(){this.terminatePermutation();let t={type:"Permutation",children:[]};return this.context.block.children.push(t),this.context.permutation=t,this}startPermutationBlock(t){let n={type:"Permutation",children:[]},r={type:t,children:[n]};return this.context.permutation.children.push(r),this.context={block:r,permutation:n,parent:this.context},this}endPermutationBlock(){let{parent:t}=this.context;if(!t)throw new Error("Unexpected block ending");return this.terminatePermutation(),this.context=this.context.parent,this}};var U=e=>{let t=new V;return j(e,({item:n})=>{try{switch(n.kind){case d:t.consumeAtomToken(n);break;case x:t.consumeTextBlockToken(n);break;case g:t.startPermutationBlock("PermutationBlock");break;case P:t.endPermutationBlock();break;case S:t.startPermutationBlock("EmbeddedPermutationBlock");break;case A:t.endPermutationBlock();break;case B:t.startPermutationBlock("ParentheticalPermutationBlock");break;case K:t.endPermutationBlock();break;case R:t.nextPermutation();break;case E:t.nextPermutation();break;case y:t.nextPermutation();break;default:break}}catch(r){throw new k(r,n)}}),t.end().root};var $=e=>{if(C(e))return e;let[t,...n]=e.parts,r=!1,o=c=>b(c)?s.createCompound(c.parts.map(o)):c.key==="&"?(r=!0,t):c,i=n.map(o);return r?s.createCompound(i):e};var z=e=>{e=Array.isArray(e)?e.join(`
`):e;let t=L(e,Object.values(w)),n=U(t),r=Z(n);return D(r.map(Y))},G=e=>z(e)[0]||q,Kt=e=>e instanceof s?e:s.createAtom(e),h=e=>Array.isArray(e)?e.flatMap(h):e instanceof s?[e]:z(e),Y=e=>{if(e.length===0)return null;let t=r=>{let o=r.map(i=>Array.isArray(i)?t(i):s.createAtom(i.loc.source)).filter(Boolean);return o.length===1?o[0]:s.createCompound(o)},n=t(e);return $(n)},Z=e=>{let t=[],n=(o,i=[])=>{switch(o.type){case"Atom":return[[o.token]];case"TextBlock":return[[o.token]];case"Root":return o.children.flatMap(a=>n(a,[]));case"PermutationBlock":return o.children.flatMap(a=>n(a,[]));case"ParentheticalPermutationBlock":return o.children.forEach(a=>{let p=N(i,n(a));t.push(...p)}),[];case"EmbeddedPermutationBlock":return o.children.flatMap(a=>n(a,[]).map(p=>[p]));case"Permutation":{let c=o,a=[],p=[];return c.children.forEach(u=>{let m=n(u,p);a.length===0?a=m:m.length>0&&(a=a.flatMap(F=>m.map(H=>[...F,...H]))),p=m}),a}default:throw new Error("Unhandled AST node type: "+o.type)}};return[...n(e),...t]};var Mt=e=>{let t=h(e),n=tt.bind(null,t);return{patterns:t,interpolate:n}},Lt=(e,t)=>{let n=[];return e.forEach(r=>{let o=r.parts.length;t.filter(i=>i.parts.length===o&&i.key!==r.key).forEach(i=>{let c=W(i,r);c&&n.push({pattern:r,concept:i,variables:c})})}),n},_=(e,t)=>typeof e=="string"?_(G(e),t):v(e,t).key,v=(e,t)=>f(e)?s.createCompound(e.parts.map(n=>v(n,t))):t[e.key]?h(t[e.key])[0]:e,tt=(e,t)=>{let n=h(e),r={};Object.entries(t).forEach(([i,c])=>{r[i]=h(c)});let o=Object.entries(r).reduce((i,[c,a])=>a.flatMap(p=>i.map(u=>v(u,{[c]:p}))),n);return O(o,i=>i.key)},W=(e,t)=>{let n=t.parts.length;if(e.parts.length!==n)return null;let r={};for(let o=0;o<n;o+=1){let i=e.parts[o],c=t.parts[o];if(T(c)){let a=c.key,p=r[a];if(p&&p.key!==i.key)return null;r[a]=i}else if(f(c)){let a=W(i,c);if(!a)return null;for(let[p,u]of Object.entries(a)){let m=r[p];if(m&&m.key!==u.key)return null;r[p]=u}}else if(i.key!==c.key)return null}return r},et=(...e)=>{let t=new Map;return e.flat().forEach(n=>{T(n)?t.set(n.key,n):f(n)&&et(n.parts).forEach(r=>{t.set(r.key,r)})}),Array.from(t.values())};})();
